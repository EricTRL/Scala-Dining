{% extends 'base.html' %}
{% load credit_tags %}


{% block content %}
    <nav>
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                {% with d=payment.dining_list.date %}
                    <a href="{% url 'day_view' year=d.year month=d.month day=d.day %}">
                        {{ d|date:"SHORT_DATE_FORMAT" }}
                    </a>
                {% endwith %}
            </li>
            <li class="breadcrumb-item">
                <a href="{{ payment.dining_list.get_absolute_url }}">Dining list</a>
            </li>
            <li class="breadcrumb-item active">Groceries payment</li>
        </ol>
    </nav>
    <h2>Groceries payment</h2>
    <div class="row mb-3">
        <div class="col-sm-2"><strong>Cost</strong></div>
        <div class="col-sm-10">{{ payment.total_cost|euro }}</div>
    </div>
    <div class="row mb-3">
        <div class="col-sm-2"><strong>Cost per person ({{ payment.entries.count }})</strong></div>
        <div class="col-sm-10">{{ payment.cost_pp|euro }}</div>
    </div>
    <div class="row mb-3">
        <div class="col-sm-2"><strong>Payment link</strong></div>
        <div class="col-sm-10">
            {% if payment.payment_link %}
                <a href="{{ payment.payment_link }}" target="_blank">{{ payment.payment_link }}</a>
            {% else %}-{% endif %}
        </div>
    </div>
    <div class="row mb-3">
        <div class="col-sm-2"><strong>Remarks</strong></div>
        <div class="col-sm-10">{{ payment.remarks|default:"-" }}</div>
    </div>
    <h3>Diners</h3>
    <table class="table table-hover" style="table-layout: fixed;">
        <thead>
        <tr>
            <th scope="col">Diner</th>
            <th scope="col">Paid</th>
            <th scope="col">Change</th>
        </tr>
        </thead>
        <tbody>
        {% for entry in payment.entries.all %}
            <tr class="position-relative">
                <td>
                    {% if entry.is_external %}
                        {{ entry.external_name }} <span class="badge badge-secondary">External diner</span>
                    {% else %}{{ entry.user }}{% endif %}
                    {% if entry.is_receiver %}
                        <span class="badge badge-secondary">Receiver</span>
                    {% endif %}
                </td>
                <td>
                    {% if not entry.is_receiver %}
                        {% if entry.paid %}
                            <span class="text-success"><i class="fas fa-check-circle"></i> Paid</span>
                        {% else %}
                            <span class="text-danger"><i class="fas fa-times-circle"></i> Not paid</span>
                        {% endif %}
                    {% endif %}
                </td>
                <td>
                    {% if not entry.is_receiver %}
                        {% if entry.transaction %}
                            <span class="text-secondary">Paid automatically</span>
                        {% else %}
                            <form method="post" action="{% url 'groceries:payment-detail' pk=payment.pk %}"
                                  class="d-inline-block">
                                {% csrf_token %}
                                <input type="hidden" name="entry_id" value="{{ entry.pk }}">
                                <button type="submit" name="paid"
                                        value="{% if entry.paid %}false{% else %}true{% endif %}"
                                        class="btn btn-secondary btn-sm stretched-link">
                                    Toggle
                                </button>
                            </form>
                        {% endif %}
                    {% endif %}
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <button type="button" class="btn btn-warning mb-3"><i class="fas fa-ban"></i> Cancel</button>
    <p>Cancelling a groceries payment will refund all automatic charges.</p>
{% endblock %}